<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éŠæˆ² 1ï¼šç¥ç¶“å‚³å°æ¥é¾ - åœ‹ä¸­ç”Ÿç‰©è‡ªå­¸ç¶²</title>
    <style>
        :root {
            --primary: #2980b9;
            --secondary: #3498db;
            --success: #27ae60;
            --error: #c0392b;
            --bg: #ecf0f1;
            --card-bg: #fff;
            --slot-bg: #dfe6e9;
        }

        body {
            font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none; /* é˜²æ­¢é¸å–æ–‡å­—å¹²æ“¾æ‹–æ›³ */
        }

        /* --- é ‚éƒ¨è³‡è¨Š --- */
        header {
            width: 100%;
            background: var(--primary);
            color: white;
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .level-indicator {
            font-size: 1.2rem;
            margin-top: 5px;
            color: #a9cce3;
        }

        /* --- éŠæˆ²å€åŸŸ --- */
        .game-container {
            width: 95%;
            max-width: 900px;
            margin: 20px auto;
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .scenario-box {
            background: #eaf2f8;
            border-left: 5px solid var(--secondary);
            padding: 15px;
            width: 90%;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .scenario-title {
            font-weight: bold;
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 5px;
        }

        /* --- æ”¾ç½®å€åŸŸ (Slots) --- */
        .pathway-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            width: 100%;
        }

        .slot-wrapper {
            display: flex;
            align-items: center;
        }

        .slot {
            width: 120px;
            height: 80px;
            background-color: var(--slot-bg);
            border: 3px dashed #bdc3c7;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            color: #95a5a6;
            transition: all 0.3s;
            position: relative;
        }

        .slot.active {
            border-color: var(--secondary);
            background-color: #ebf5fb;
        }

        .slot.correct {
            border-color: var(--success);
            border-style: solid;
            background-color: #eafaf1;
            color: var(--success);
        }

        .arrow {
            font-size: 1.5rem;
            color: #7f8c8d;
            margin: 0 5px;
        }

        /* --- å¡ç‰‡å€åŸŸ (Draggables) --- */
        .cards-pool {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            background: #f7f9f9;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            min-height: 100px;
        }

        .card {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: grab;
            font-weight: bold;
            color: var(--primary);
            border: 2px solid transparent;
            transition: transform 0.2s, box-shadow 0.2s;
            touch-action: none; /* é‡è¦ï¼šé˜²æ­¢æ‰‹æ©Ÿæ²å‹•é é¢ */
        }

        .card:active {
            cursor: grabbing;
            transform: scale(1.05);
        }

        .card.dragging {
            opacity: 0.5;
        }

        .card.placed {
            cursor: default;
            background: transparent;
            box-shadow: none;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .card.selected {
            border-color: var(--secondary);
            background-color: #d6eaf8;
        }

        /* éŒ¯èª¤å‹•ç•« */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }
        .shake { animation: shake 0.4s ease-in-out; border-color: var(--error) !important; color: var(--error) !important; }

        /* --- è¦–çª— --- */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.5rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        .start-btn { background: #e67e22; color: white; }
        .start-btn:hover { transform: scale(1.05); }

        .next-btn {
            background: #27ae60;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .next-btn.disabled {
            background: #95a5a6;
            cursor: not-allowed;
            pointer-events: none;
            opacity: 0.7;
        }

        .hidden { display: none !important; }

    </style>
</head>
<body>

    <header>
        <h1>ç¥ç¶“å‚³å°æ¥é¾</h1>
        <div class="level-indicator" id="level-display">é—œå¡ 1 / 2</div>
    </header>

    <div class="game-container">
        <div class="scenario-box">
            <div class="scenario-title" id="scenario-title">é¡Œç›®è¼‰å…¥ä¸­...</div>
            <div id="scenario-desc">è«‹å°‡ä¸‹æ–¹çš„å¡ç‰‡æ‹–æ›³åˆ°æ­£ç¢ºçš„æµç¨‹ä½ç½®ä¸­ã€‚</div>
        </div>

        <div class="pathway-container" id="slots-area">
            </div>

        <div class="cards-pool" id="cards-area">
            </div>
    </div>

    <div id="start-screen" class="modal">
        <h1>ğŸ§¬ ç¥ç¶“å‚³å°æ¥é¾</h1>
        <p style="text-align:center; font-size:1.2rem; line-height:1.6; max-width:600px;">
            è«‹å°‡æ‰“äº‚çš„ç¥ç¶“å‚³å°æ­¥é©Ÿï¼Œä¾ç…§æ­£ç¢ºé †åºæ’åˆ—ã€‚<br>
            <br>
            <strong>ç©æ³•ï¼š</strong><br>
            æ‹–æ›³å¡ç‰‡åˆ°ä¸Šæ–¹çš„è™›ç·šæ ¼å­ä¸­ã€‚<br>
            å¦‚æœé †åºæ­£ç¢ºï¼Œå¡ç‰‡æœƒå¸é™„ï¼›<br>
            å¦‚æœéŒ¯èª¤ï¼Œå¡ç‰‡æœƒå½ˆå›åŸè™•ï¼
        </p>
        <button class="btn start-btn" onclick="startGame()">é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <div id="end-screen" class="modal hidden">
        <h1 style="color:#2ecc71">æŒ‘æˆ°æˆåŠŸï¼</h1>
        <p style="font-size:1.2rem;">ä½ å·²ç¶“ç²¾é€šç¥ç¶“å‚³å°çš„è·¯å¾‘äº†ï¼</p>
        
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="btn start-btn" onclick="startGame()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
            <a href="unit4_lab.html" id="next-page-btn" class="btn next-btn">â¡ï¸ å‰å¾€å–®å…ƒ 4ï¼šè™›æ“¬å¯¦é©—å®¤</a>
        </div>
    </div>

<script>
    // --- éŸ³æ•ˆç”¢ç”Ÿå™¨ (ç„¡éœ€å¤–éƒ¨æª”æ¡ˆ) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        if (type === 'correct') {
            // å®å’šè² (é«˜éŸ³)
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(500, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.5);
        } else {
            // éŒ¯èª¤è² (ä½éŸ³å—¡å—¡)
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        }
    }

    // --- éŠæˆ²è³‡æ–™ ---
    const levels = [
        {
            title: "æƒ…å¢ƒä¸€ï¼šé–‹è»Šçœ‹åˆ°ç´…ç‡ˆè¸©ç…è»Š (æ„è­˜è¡Œç‚º)",
            items: ["çœ¼ç›(å—å™¨)", "æ„Ÿè¦ºç¥ç¶“å…ƒ", "å¤§è…¦", "è„Šé«“", "é‹å‹•ç¥ç¶“å…ƒ", "è…³éƒ¨è‚Œè‚‰(å‹•å™¨)"]
        },
        {
            title: "æƒ…å¢ƒäºŒï¼šæ‰‹ç¢°åˆ°ç†±é‹ç«‹åˆ»ç¸®å› (åå°„ä½œç”¨)",
            items: ["çš®è†š(å—å™¨)", "æ„Ÿè¦ºç¥ç¶“å…ƒ", "è„Šé«“", "é‹å‹•ç¥ç¶“å…ƒ", "æ‰‹éƒ¨è‚Œè‚‰(å‹•å™¨)"]
        }
    ];

    let currentLevelIdx = 0;
    let placedCount = 0;
    let selectedCard = null; // ç”¨æ–¼é»æ“Šæ¨¡å¼

    // --- DOM ---
    const slotsArea = document.getElementById('slots-area');
    const cardsArea = document.getElementById('cards-area');
    const titleEl = document.getElementById('scenario-title');
    const levelDisplay = document.getElementById('level-display');

    function startGame() {
        currentLevelIdx = 0;
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('end-screen').classList.add('hidden');
        loadLevel(currentLevelIdx);
    }

    function loadLevel(index) {
        const level = levels[index];
        titleEl.textContent = level.title;
        levelDisplay.textContent = `é—œå¡ ${index + 1} / ${levels.length}`;
        placedCount = 0;
        selectedCard = null;

        // æ¸…ç©ºå€åŸŸ
        slotsArea.innerHTML = '';
        cardsArea.innerHTML = '';

        // å»ºç«‹ Slots (æ ¼å­)
        level.items.forEach((item, i) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'slot-wrapper';
            
            const slot = document.createElement('div');
            slot.className = 'slot';
            slot.dataset.index = i; // ç´€éŒ„æ­£ç¢ºé †åº
            slot.dataset.answer = item;
            slot.textContent = i + 1; // é¡¯ç¤ºæ­¥é©Ÿç·¨è™Ÿ
            
            // æ‹–æ”¾äº‹ä»¶
            slot.addEventListener('dragover', handleDragOver);
            slot.addEventListener('drop', handleDrop);
            slot.addEventListener('click', () => handleSlotClick(slot)); // é»æ“Šæ¨¡å¼

            wrapper.appendChild(slot);
            
            // åŠ ç®­é ­ (é™¤äº†æœ€å¾Œä¸€å€‹)
            if (i < level.items.length - 1) {
                const arrow = document.createElement('div');
                arrow.className = 'arrow';
                arrow.textContent = 'â†’';
                wrapper.appendChild(arrow);
            }
            
            slotsArea.appendChild(wrapper);
        });

        // å»ºç«‹ Cards (æ‰“äº‚é †åº)
        const shuffledItems = [...level.items].sort(() => Math.random() - 0.5);
        shuffledItems.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.draggable = true;
            card.textContent = item;
            card.id = 'card-' + item; // å”¯ä¸€ID
            
            // æ‹–æ”¾äº‹ä»¶
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('touchstart', handleTouchStart, {passive: false});
            card.addEventListener('click', () => handleCardClick(card)); // é»æ“Šæ¨¡å¼

            cardsArea.appendChild(card);
        });
    }

    // --- æ‹–æ”¾é‚è¼¯ (Mouse) ---
    function handleDragStart(e) {
        e.dataTransfer.setData('text/plain', e.target.textContent);
        e.dataTransfer.effectAllowed = 'move';
        e.target.classList.add('dragging');
    }

    function handleDragOver(e) {
        e.preventDefault(); // å…è¨±æ”¾ç½®
        e.target.classList.add('active');
    }

    function handleDrop(e) {
        e.preventDefault();
        const slot = e.target;
        slot.classList.remove('active');
        
        // æ‰¾åˆ°æ­£åœ¨æ‹–æ›³çš„å¡ç‰‡
        const draggingCard = document.querySelector('.card.dragging');
        if (!draggingCard) return;

        validateMove(slot, draggingCard);
        draggingCard.classList.remove('dragging');
    }

    // --- è§¸æ§æ‹–æ›³é‚è¼¯ (Touch - ç°¡æ˜“æ¨¡æ“¬) ---
    let touchCard = null;

    function handleTouchStart(e) {
        touchCard = e.target;
        // ç‚ºäº†ä¸å¹²æ“¾æ²å‹•ï¼Œé€™è£¡ä¸åš preventDefaultï¼Œé™¤éæˆ‘å€‘è¦å¯¦ä½œå®Œå…¨è·Ÿéš¨æ‰‹æŒ‡
        // é€™è£¡æ¡ç”¨ã€Œé»æ“Šé¸å–ã€æ¨¡å¼ä¾†æ”¯æ´æ‰‹æ©Ÿï¼Œé«”é©—è¼ƒå¥½
        handleCardClick(touchCard);
    }

    // --- é»æ“Šæ¨¡å¼é‚è¼¯ (æ··åˆæ”¯æ´æ‰‹æ©Ÿèˆ‡æ»‘é¼ ) ---
    function handleCardClick(card) {
        if (card.classList.contains('placed')) return;

        // å¦‚æœä¹‹å‰æœ‰é¸ä¸­çš„ï¼Œå–æ¶ˆé¸ä¸­
        if (selectedCard) {
            selectedCard.classList.remove('selected');
        }

        // é¸ä¸­ç•¶å‰å¡ç‰‡
        selectedCard = card;
        card.classList.add('selected');
    }

    function handleSlotClick(slot) {
        if (!selectedCard) return; // æ²’æœ‰é¸ä¸­å¡ç‰‡
        if (slot.classList.contains('correct')) return; // è©²æ ¼å·²å®Œæˆ

        validateMove(slot, selectedCard);
        selectedCard.classList.remove('selected');
        selectedCard = null;
    }

    // --- æ ¸å¿ƒé©—è­‰é‚è¼¯ ---
    function validateMove(slot, card) {
        const expected = slot.dataset.answer;
        const actual = card.textContent;

        if (expected === actual) {
            // ç­”å°
            playSound('correct');
            slot.textContent = '';
            slot.classList.add('correct');
            
            // è¦–è¦ºç§»å‹•
            card.classList.add('placed');
            card.draggable = false;
            slot.appendChild(card);
            
            placedCount++;
            checkLevelComplete();
        } else {
            // ç­”éŒ¯ (å½ˆå›)
            playSound('wrong');
            card.classList.add('shake');
            setTimeout(() => {
                card.classList.remove('shake');
            }, 500);
            
            // è¦–è¦ºæç¤ºéŒ¯èª¤
            slot.style.borderColor = '#c0392b';
            setTimeout(() => {
                slot.style.borderColor = ''; // æ¢å¾©åŸç‹€
            }, 500);
        }
    }

    function checkLevelComplete() {
        const currentLevel = levels[currentLevelIdx];
        if (placedCount === currentLevel.items.length) {
            setTimeout(() => {
                if (currentLevelIdx < levels.length - 1) {
                    alert("âœ… å¤ªæ£’äº†ï¼é€²å…¥ä¸‹ä¸€é—œï¼");
                    currentLevelIdx++;
                    loadLevel(currentLevelIdx);
                } else {
                    document.getElementById('end-screen').classList.remove('hidden');
                }
            }, 500);
        }
    }

    // å…¨å±€å–æ¶ˆ slot active æ¨£å¼ (ç•¶æ‹–æ›³é›¢é–‹æ™‚)
    document.addEventListener('dragend', () => {
        document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
    });

</script>
</body>
</html>